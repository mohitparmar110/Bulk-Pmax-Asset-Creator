<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OverlayForge</title>
  <meta name="description" content="OverlayForge applies the correct overlay to images automatically by size." />

  <style>
    :root{
      --bg0:#070914;
      --bg1:#0b1020;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);

      --text:#eef2ff;
      --muted:rgba(238,242,255,.72);

      --brand:#7c3aed;
      --brand2:#a78bfa;

      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --r:22px;
      --r2:16px;
      --shadow: 0 22px 80px rgba(0,0,0,.55);
      --shadow2: 0 12px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 700px at 20% 0%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(167,139,250,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{max-width:1180px;margin:0 auto;padding:22px 18px 110px}

    /* Top hero */
    .hero{
      border:1px solid var(--line);
      border-radius: var(--r);
      background:
        radial-gradient(1000px 500px at 20% 0%, rgba(124,58,237,.22), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(12px);
      padding:18px 18px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .logo{
      width:42px;height:42px;border-radius:16px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 16px 40px rgba(124,58,237,.25);
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px}
    .brand p{margin:3px 0 0;font-size:12px;color:var(--muted)}
    .heroRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;
    }
    .pill b{color:var(--text)}
    .statusPill{
      border:1px solid rgba(124,58,237,.35);
      background: rgba(124,58,237,.10);
      color: rgba(234,240,255,.95);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 10px 24px rgba(124,58,237,.12);
    }
    .spark{
      width:9px;height:9px;border-radius:999px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 0 0 3px rgba(124,58,237,.18);
    }

    /* Layout */
    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
    }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .panelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line2);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      background: rgba(255,255,255,.02);
    }
    .panelHead h2{margin:0;font-size:14px}
    .panelHead .hint{font-size:12px;color:var(--muted)}
    .panelBody{padding:16px}

    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width: 980px){ .grid3{grid-template-columns:1fr} }

    /* Template cards */
    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r);
      padding:12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;inset:-1px;
      background:
        radial-gradient(600px 200px at 15% 0%, rgba(124,58,237,.16), transparent 60%),
        radial-gradient(500px 240px at 90% 10%, rgba(167,139,250,.10), transparent 60%);
      pointer-events:none;
      opacity:.65;
    }
    .card > *{position:relative}
    .cardTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cardTop h3{margin:0;font-size:13px}
    .sub{margin-top:2px;font-size:12px;color:var(--muted)}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      font-size:11px;color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.14)}
    .chip.ok{border-color:rgba(34,197,94,.35); color:rgba(34,197,94,.95); background:rgba(34,197,94,.08)}
    .chip.ok .dot{background:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.14)}
    .chip.bad{border-color:rgba(239,68,68,.35); color:rgba(239,68,68,.95); background:rgba(239,68,68,.08)}
    .chip.bad .dot{background:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.14)}

    .uploadRow{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}

    .uploader{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: var(--r2);
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .uploader:hover{transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(167,139,250,.35)}
    .uLeft{display:flex;gap:10px;align-items:center;min-width:0}
    .ic{
      width:36px;height:36px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .ic svg{opacity:.9}
    .uText{min-width:0}
    .uText b{display:block;font-size:12px}
    .uText span{display:block;font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .uAction{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:8px 10px;border-radius:999px;
      font-size:12px;font-weight:850;
      white-space:nowrap;
    }
    .hiddenInput{display:none}

    .metaLine{font-size:12px;color:var(--muted);margin-top:8px;min-height:16px}

    .thumb{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius: var(--r2);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      min-height:140px;
    }
    .thumb .cap{
      position:absolute;top:10px;left:10px;
      font-size:11px;color:rgba(234,240,255,.88);
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(6px);
    }
    canvas{width:100%;height:auto;display:block}

    /* Images upload big area */
    .drop{
      border:1px dashed rgba(167,139,250,.60);
      background: rgba(124,58,237,.08);
      border-radius: var(--r);
      padding:16px;
      display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;align-items:center;
      transition: background .12s ease, border-color .12s ease, transform .12s ease;
    }
    .drop.drag{transform: translateY(-2px); background: rgba(124,58,237,.14); border-color: rgba(167,139,250,.85);}
    .drop strong{display:block;font-size:13px}
    .drop span{display:block;font-size:12px;color:var(--muted);margin-top:3px}

    .select{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      outline:none;
    }

    /* Right side cards */
    .rightStack{display:grid;gap:12px}
    .info{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r);
      padding:14px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .info h4{margin:0 0 6px;font-size:13px}
    .info p{margin:0;color:var(--muted);font-size:12px;line-height:1.5}
    .info ul{margin:8px 0 0;padding-left:16px;color:var(--muted);font-size:12px;line-height:1.6}
    .info li{margin:4px 0}

    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .stat{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:10px 12px;
    }
    .stat .k{font-size:11px;color:var(--muted)}
    .stat .v{margin-top:2px;font-size:18px;font-weight:950}

    .progress{
      margin-top:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      overflow:hidden;
      height:12px;
    }
    .bar{
      width:0%;
      height:100%;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      transition: width .18s ease;
    }

    .log{
      margin-top:12px;
      white-space:pre-wrap;
      background: rgba(0,0,0,.28);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px;
      min-height:140px;
      font-size:12px;
      color: rgba(234,240,255,.86);
      overflow:auto;
    }

    /* Bottom action bar */
    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      padding:12px;
      background: rgba(7,10,18,.55);
      border-top:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
    }
    .bottomInner{
      max-width:1180px;margin:0 auto;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .mini{font-size:12px;color:var(--muted)}

    .btnPrimary{
      border:1px solid rgba(124,58,237,.55);
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 12px 28px rgba(124,58,237,.20);
      padding:10px 14px;
      border-radius: 14px;
      font-weight:950;
      cursor:pointer;
      color:var(--text);
      transition: transform .12s ease, filter .12s ease;
    }
    .btnPrimary:hover{transform: translateY(-1px); filter:brightness(1.05)}
    .btnPrimary:disabled{opacity:.55;cursor:not-allowed;transform:none}
  </style>
</head>

<body>
  <div class="wrap">
    <!-- HERO -->
    <div class="hero">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>OverlayForge</h1>
          <p>Apply overlays to images automatically by size.</p>
        </div>
      </div>

      <div class="heroRight">
        <div class="pill"><b>1200×1200</b> Square</div>
        <div class="pill"><b>1200×628</b> Landscape</div>
        <div class="pill"><b>960×1200</b> Portrait</div>
        <div class="statusPill"><span class="spark"></span><span id="topStatus">Waiting</span></div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT MAIN -->
      <div class="panel">
        <div class="panelHead">
          <div>
            <h2>Overlays</h2>
            <div class="hint">Upload one overlay PNG per size. Exact dimensions only. Preview is optional.</div>
          </div>
          <div class="hint">Tip: keep overlays transparent PNG</div>
        </div>

        <div class="panelBody">
          <div class="grid3">
            <!-- 1200x1200 -->
            <div class="card">
              <div class="cardTop">
                <div>
                  <h3>Square</h3>
                  <div class="sub">1200×1200</div>
                </div>
                <div class="chip" id="chip_1200x1200"><span class="dot"></span><span id="chipText_1200x1200">Not uploaded</span></div>
              </div>

              <div class="uploadRow">
                <div class="uploader" id="pickOv_1200x1200">
                  <div class="uLeft">
                    <div class="ic" aria-hidden="true">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M7 17a4 4 0 0 1 0-8 5 5 0 0 1 9.7-1.7A4 4 0 0 1 17 17" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round"/>
                        <path d="M12 12v8m0-8 3 3m-3-3-3 3" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="uText">
                      <b>Overlay PNG</b>
                      <span id="ovName_1200x1200">Choose file</span>
                    </div>
                  </div>
                  <div class="uAction">Upload</div>
                </div>
                <input class="hiddenInput" id="ov_1200_1200" type="file" accept="image/png"/>
                <div class="metaLine" id="meta_1200x1200"></div>

                <div class="uploader" id="pickPv_1200x1200">
                  <div class="uLeft">
                    <div class="ic" aria-hidden="true">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Z" stroke="rgba(238,242,255,.9)" stroke-width="2"/>
                        <path d="M8 13l2-2 4 4 2-2 2 2" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="uText">
                      <b>Preview image (optional)</b>
                      <span id="pvName_1200x1200">Choose file</span>
                    </div>
                  </div>
                  <div class="uAction">Preview</div>
                </div>
                <input class="hiddenInput" id="pv_1200_1200" type="file" accept="image/*"/>

                <div class="thumb">
                  <div class="cap">Preview</div>
                  <canvas id="cv_1200_1200" width="1200" height="1200"></canvas>
                </div>
              </div>
            </div>

            <!-- 1200x628 -->
            <div class="card">
              <div class="cardTop">
                <div>
                  <h3>Landscape</h3>
                  <div class="sub">1200×628</div>
                </div>
                <div class="chip" id="chip_1200x628"><span class="dot"></span><span id="chipText_1200x628">Not uploaded</span></div>
              </div>

              <div class="uploadRow">
                <div class="uploader" id="pickOv_1200x628">
                  <div class="uLeft">
                    <div class="ic" aria-hidden="true">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M7 17a4 4 0 0 1 0-8 5 5 0 0 1 9.7-1.7A4 4 0 0 1 17 17" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round"/>
                        <path d="M12 12v8m0-8 3 3m-3-3-3 3" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="uText">
                      <b>Overlay PNG</b>
                      <span id="ovName_1200x628">Choose file</span>
                    </div>
                  </div>
                  <div class="uAction">Upload</div>
                </div>
                <input class="hiddenInput" id="ov_1200_628" type="file" accept="image/png"/>
                <div class="metaLine" id="meta_1200x628"></div>

                <div class="uploader" id="pickPv_1200x628">
                  <div class="uLeft">
                    <div class="ic" aria-hidden="true">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Z" stroke="rgba(238,242,255,.9)" stroke-width="2"/>
                        <path d="M8 13l2-2 4 4 2-2 2 2" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="uText">
                      <b>Preview image (optional)</b>
                      <span id="pvName_1200x628">Choose file</span>
                    </div>
                  </div>
                  <div class="uAction">Preview</div>
                </div>
                <input class="hiddenInput" id="pv_1200_628" type="file" accept="image/*"/>

                <div class="thumb">
                  <div class="cap">Preview</div>
                  <canvas id="cv_1200_628" width="1200" height="628"></canvas>
                </div>
              </div>
            </div>

            <!-- 960x1200 -->
            <div class="card">
              <div class="cardTop">
                <div>
                  <h3>Portrait</h3>
                  <div class="sub">960×1200</div>
                </div>
                <div class="chip" id="chip_960x1200"><span class="dot"></span><span id="chipText_960x1200">Not uploaded</span></div>
              </div>

              <div class="uploadRow">
                <div class="uploader" id="pickOv_960x1200">
                  <div class="uLeft">
                    <div class="ic" aria-hidden="true">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M7 17a4 4 0 0 1 0-8 5 5 0 0 1 9.7-1.7A4 4 0 0 1 17 17" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round"/>
                        <path d="M12 12v8m0-8 3 3m-3-3-3 3" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="uText">
                      <b>Overlay PNG</b>
                      <span id="ovName_960x1200">Choose file</span>
                    </div>
                  </div>
                  <div class="uAction">Upload</div>
                </div>
                <input class="hiddenInput" id="ov_960_1200" type="file" accept="image/png"/>
                <div class="metaLine" id="meta_960x1200"></div>

                <div class="uploader" id="pickPv_960x1200">
                  <div class="uLeft">
                    <div class="ic" aria-hidden="true">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Z" stroke="rgba(238,242,255,.9)" stroke-width="2"/>
                        <path d="M8 13l2-2 4 4 2-2 2 2" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="uText">
                      <b>Preview image (optional)</b>
                      <span id="pvName_960x1200">Choose file</span>
                    </div>
                  </div>
                  <div class="uAction">Preview</div>
                </div>
                <input class="hiddenInput" id="pv_960_1200" type="file" accept="image/*"/>

                <div class="thumb">
                  <div class="cap">Preview</div>
                  <canvas id="cv_960_1200" width="960" height="1200"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <!-- Upload images -->
          <div class="drop" id="dropZone">
            <div>
              <strong>Upload images</strong>
              <span>Drag & drop or click to choose. Mixed sizes supported.</span>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <div class="uploader" id="pickImages" style="padding:10px 12px;border-radius:14px">
                <div class="uLeft">
                  <div class="ic" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                      <path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Z" stroke="rgba(238,242,255,.9)" stroke-width="2"/>
                      <path d="M8 13l2-2 4 4 2-2 2 2" stroke="rgba(238,242,255,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div class="uText">
                    <b>Choose images</b>
                    <span id="imagesName">No files selected</span>
                  </div>
                </div>
                <div class="uAction">Browse</div>
              </div>
              <input class="hiddenInput" id="images" type="file" accept="image/*" multiple/>
              <select class="select" id="format">
                <option value="image/png">Export PNG</option>
                <option value="image/jpeg">Export JPG</option>
              </select>
            </div>
          </div>

          <div class="stats">
            <div class="stat"><div class="k">Total</div><div class="v" id="st_total">0</div></div>
            <div class="stat"><div class="k">Progress</div><div class="v" id="st_prog">0%</div></div>
          </div>

          <div class="progress"><div class="bar" id="bar"></div></div>
          <div class="log" id="log"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="rightStack">
        <div class="info">
          <h4>Output</h4>
          <p>Downloads a ZIP with folders:</p>
          <ul>
            <li><b>1200x1200</b>, <b>1200x628</b>, <b>960x1200</b></li>
            <li><b>unmatched</b> (sizes that don’t match)</li>
          </ul>
        </div>

        <div class="info">
          <h4>When overlay won’t apply</h4>
          <p>An image goes into <b>unmatched</b> if:</p>
          <ul>
            <li>Size isn’t exactly one of the 3 targets</li>
            <li>Overlay PNG size doesn’t match the target</li>
          </ul>
        </div>

        <div class="info">
          <h4>Results</h4>
          <div class="stats" style="margin-top:10px">
            <div class="stat"><div class="k">Processed</div><div class="v" id="st_ok">0</div></div>
            <div class="stat"><div class="k">Unmatched</div><div class="v" id="st_bad">0</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottomBar">
    <div class="bottomInner">
      <div class="mini" id="bottomStatus">Upload overlays + images to enable download.</div>
      <button class="btnPrimary" id="runBtn" disabled>Download ZIP</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const TARGETS = [
      { key:"1200x1200", w:1200, h:1200 },
      { key:"1200x628",  w:1200, h:628  },
      { key:"960x1200",  w:960,  h:1200 }
    ];

    const els = {
      topStatus: document.getElementById("topStatus"),
      bottomStatus: document.getElementById("bottomStatus"),

      imagesName: document.getElementById("imagesName"),

      ov: {
        "1200x1200": document.getElementById("ov_1200_1200"),
        "1200x628":  document.getElementById("ov_1200_628"),
        "960x1200":  document.getElementById("ov_960_1200"),
      },
      pv: {
        "1200x1200": document.getElementById("pv_1200_1200"),
        "1200x628":  document.getElementById("pv_1200_628"),
        "960x1200":  document.getElementById("pv_960_1200"),
      },
      canvas: {
        "1200x1200": document.getElementById("cv_1200_1200"),
        "1200x628":  document.getElementById("cv_1200_628"),
        "960x1200":  document.getElementById("cv_960_1200"),
      },

      chip: {
        "1200x1200": document.getElementById("chip_1200x1200"),
        "1200x628":  document.getElementById("chip_1200x628"),
        "960x1200":  document.getElementById("chip_960x1200"),
      },
      chipText: {
        "1200x1200": document.getElementById("chipText_1200x1200"),
        "1200x628":  document.getElementById("chipText_1200x628"),
        "960x1200":  document.getElementById("chipText_960x1200"),
      },

      meta: {
        "1200x1200": document.getElementById("meta_1200x1200"),
        "1200x628":  document.getElementById("meta_1200x628"),
        "960x1200":  document.getElementById("meta_960x1200"),
      },
      ovName: {
        "1200x1200": document.getElementById("ovName_1200x1200"),
        "1200x628":  document.getElementById("ovName_1200x628"),
        "960x1200":  document.getElementById("ovName_960x1200"),
      },
      pvName: {
        "1200x1200": document.getElementById("pvName_1200x1200"),
        "1200x628":  document.getElementById("pvName_1200x628"),
        "960x1200":  document.getElementById("pvName_960x1200"),
      },

      pickOv: {
        "1200x1200": document.getElementById("pickOv_1200x1200"),
        "1200x628":  document.getElementById("pickOv_1200x628"),
        "960x1200":  document.getElementById("pickOv_960x1200"),
      },
      pickPv: {
        "1200x1200": document.getElementById("pickPv_1200x1200"),
        "1200x628":  document.getElementById("pickPv_1200x628"),
        "960x1200":  document.getElementById("pickPv_960x1200"),
      },

      dropZone: document.getElementById("dropZone"),
      pickImages: document.getElementById("pickImages"),
      images: document.getElementById("images"),
      format: document.getElementById("format"),

      runBtn: document.getElementById("runBtn"),
      log: document.getElementById("log"),

      st_total: document.getElementById("st_total"),
      st_ok: document.getElementById("st_ok"),
      st_bad: document.getElementById("st_bad"),
      st_prog: document.getElementById("st_prog"),
      bar: document.getElementById("bar"),
    };

    const overlayBitmaps = new Map();

    function log(s){
      els.log.textContent += s + "\n";
      els.log.scrollTop = els.log.scrollHeight;
    }

    function setChip(key, state, text){
      const c = els.chip[key];
      c.classList.remove("ok","bad");
      if (state==="ok") c.classList.add("ok");
      if (state==="bad") c.classList.add("bad");
      els.chipText[key].textContent = text;
    }

    function keyWH(w,h){ return `${w}x${h}`; }

    async function fileToBitmap(file){
      const buf = await file.arrayBuffer();
      const blob = new Blob([buf], {type:file.type});
      return await createImageBitmap(blob);
    }

    function updateStatuses(){
      const overlaysReady = TARGETS.every(t => overlayBitmaps.has(t.key));
      const imgCount = els.images.files?.length || 0;

      els.topStatus.textContent = overlaysReady ? "Ready" : "Waiting";
      els.bottomStatus.textContent = overlaysReady
        ? (imgCount ? `${imgCount} images ready • Download enabled` : "Upload images to enable download.")
        : "Upload all 3 overlays to enable download.";
    }

    function updateRunEnabled(){
      const overlaysReady = TARGETS.every(t => overlayBitmaps.has(t.key));
      const hasImages = els.images.files && els.images.files.length > 0;
      els.runBtn.disabled = !(overlaysReady && hasImages);
      updateStatuses();
    }

    async function loadOverlayFor(key){
      const f = els.ov[key].files?.[0];
      els.ovName[key].textContent = f ? f.name : "Choose file";
      els.meta[key].textContent = "";

      if (!f){
        overlayBitmaps.delete(key);
        setChip(key, null, "Not uploaded");
        updateRunEnabled();
        return;
      }
      if (!f.type.includes("png")){
        overlayBitmaps.delete(key);
        setChip(key, "bad", "PNG required");
        els.meta[key].innerHTML = `<span style="color:rgba(239,68,68,.95);font-weight:900">Invalid file</span>`;
        updateRunEnabled();
        return;
      }

      const bmp = await fileToBitmap(f);
      const expected = TARGETS.find(t => t.key===key);
      const ok = (bmp.width===expected.w && bmp.height===expected.h);

      if (ok){
        overlayBitmaps.set(key, {bmp, w:bmp.width, h:bmp.height, file:f});
        setChip(key, "ok", "Ready");
        els.meta[key].innerHTML = `<span style="color:rgba(34,197,94,.95);font-weight:900">OK</span> • ${bmp.width}×${bmp.height}`;
      } else {
        overlayBitmaps.delete(key);
        setChip(key, "bad", "Mismatch");
        els.meta[key].innerHTML = `<span style="color:rgba(239,68,68,.95);font-weight:900">Mismatch</span> • ${bmp.width}×${bmp.height} expected ${expected.w}×${expected.h}`;
      }

      const base = els.pv[key].files?.[0];
      if (base) await renderPreview(key, base);

      updateRunEnabled();
    }

    async function renderPreview(key, baseFile){
      const cv = els.canvas[key];
      const ctx = cv.getContext("2d");
      ctx.clearRect(0,0,cv.width,cv.height);

      const baseBmp = await fileToBitmap(baseFile);
      const expected = TARGETS.find(t => t.key===key);

      if (baseBmp.width !== expected.w || baseBmp.height !== expected.h){
        ctx.fillStyle = "rgba(238,242,255,.92)";
        ctx.font = "18px system-ui";
        ctx.fillText(`Preview must be ${expected.w}×${expected.h}`, 16, 46);
        ctx.font = "13px system-ui";
        ctx.fillStyle = "rgba(238,242,255,.70)";
        ctx.fillText(`Your image: ${baseBmp.width}×${baseBmp.height}`, 16, 70);
        return;
      }

      ctx.drawImage(baseBmp, 0, 0);

      const ov = overlayBitmaps.get(key);
      if (!ov) return;

      ctx.drawImage(ov.bmp, 0, 0);
    }

    // connect tile clicks -> inputs
    TARGETS.forEach(t => {
      setChip(t.key, null, "Not uploaded");

      els.pickOv[t.key].addEventListener("click", () => els.ov[t.key].click());
      els.pickPv[t.key].addEventListener("click", () => els.pv[t.key].click());

      els.ov[t.key].addEventListener("change", () => loadOverlayFor(t.key));

      els.pv[t.key].addEventListener("change", async () => {
        const f = els.pv[t.key].files?.[0];
        els.pvName[t.key].textContent = f ? f.name : "Choose file";
        if (f) await renderPreview(t.key, f);
      });
    });

    // images upload
    els.pickImages.addEventListener("click", () => els.images.click());
    els.images.addEventListener("change", () => {
      const total = els.images.files?.length || 0;
      els.imagesName.textContent = total ? `${total} images selected` : "No files selected";
      els.st_total.textContent = String(total);
      els.st_ok.textContent = "0";
      els.st_bad.textContent = "0";
      els.st_prog.textContent = "0%";
      els.bar.style.width = "0%";
      updateRunEnabled();
    });

    // drag & drop images into zone
    els.dropZone.addEventListener("dragover", (e)=>{ e.preventDefault(); els.dropZone.classList.add("drag"); });
    els.dropZone.addEventListener("dragleave", ()=> els.dropZone.classList.remove("drag"));
    els.dropZone.addEventListener("drop", (e)=>{
      e.preventDefault();
      els.dropZone.classList.remove("drag");

      const incoming = Array.from(e.dataTransfer.files || []).filter(f => f.type.startsWith("image/"));
      if (!incoming.length) return;

      const dt = new DataTransfer();
      const existing = Array.from(els.images.files || []);
      [...existing, ...incoming].forEach(f => dt.items.add(f));
      els.images.files = dt.files;

      const total = els.images.files?.length || 0;
      els.imagesName.textContent = `${total} images selected`;
      els.st_total.textContent = String(total);
      els.st_ok.textContent = "0";
      els.st_bad.textContent = "0";
      els.st_prog.textContent = "0%";
      els.bar.style.width = "0%";

      updateRunEnabled();
    });

    function safeName(name){ return name.replace(/[^\w\-\.]+/g, "_"); }
    async function canvasToBlob(canvas, mime){
      return await new Promise(res => canvas.toBlob(res, mime, mime==="image/jpeg"?0.92:undefined));
    }

    // export
    els.log.textContent = "Ready.\n";
    els.runBtn.addEventListener("click", async ()=>{
      els.runBtn.disabled = true;
      els.log.textContent = "";

      const files = Array.from(els.images.files || []);
      const mime = els.format.value;

      let ok=0, bad=0;
      log("Processing…");

      const zip = new JSZip();
      const unmatched = zip.folder("unmatched");
      const out = {};
      TARGETS.forEach(t => out[t.key] = zip.folder(t.key));

      for (let i=0; i<files.length; i++){
        const f = files[i];
        const pct = Math.round((i / Math.max(1, files.length)) * 100);
        els.st_prog.textContent = pct + "%";
        els.bar.style.width = pct + "%";

        try{
          const bmp = await fileToBitmap(f);
          const k = keyWH(bmp.width, bmp.height);
          const target = TARGETS.find(t => t.key === k);

          if (!target){
            unmatched.folder(k).file(safeName(f.name), await f.arrayBuffer());
            bad++; els.st_bad.textContent = String(bad);
            continue;
          }

          const ov = overlayBitmaps.get(target.key);
          if (!ov){
            unmatched.folder(k).file(safeName(f.name), await f.arrayBuffer());
            bad++; els.st_bad.textContent = String(bad);
            continue;
          }

          const canvas = document.createElement("canvas");
          canvas.width = bmp.width;
          canvas.height = bmp.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(bmp, 0, 0);
          ctx.drawImage(ov.bmp, 0, 0);

          const outBlob = await canvasToBlob(canvas, mime);
          const outBuf = await outBlob.arrayBuffer();

          const ext = (mime==="image/png") ? "png" : "jpg";
          const baseName = f.name.replace(/\.[^.]+$/, "");
          const outName = `${safeName(baseName)}__${k}.${ext}`;

          out[target.key].file(outName, outBuf);

          ok++; els.st_ok.textContent = String(ok);

        }catch(e){
          bad++; els.st_bad.textContent = String(bad);
        }
      }

      els.st_prog.textContent = "100%";
      els.bar.style.width = "100%";

      log("Preparing ZIP…");
      const zipBlob = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(zipBlob);
      a.download = "overlayforge_output.zip";
      a.click();
      URL.revokeObjectURL(a.href);

      log("Done.");
      els.runBtn.disabled = false;
      updateRunEnabled();
    });

    updateRunEnabled();
  </script>
</body>
</html>
